<!DOCTYPE html>
<html lang="en"
      xmlns:="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<head th:include="admin/layout :: header">
    <title th:text="${title}"></title>
    <style>
        .pointer {cursor: pointer;}
    </style>
</head>
<body>
    <div th:include="admin/layout :: menu"></div>    
    <div id="content">
        <div id="content-header">
            <div id="breadcrumb" class="lang_eng" style="display: none"> <a href="#" title="Go to Home" class="tip-bottom"><i class="icon-home"></i>Input Data / Problem Identification form & follow up </a></div>
            <div id="breadcrumb" class="lang_indo"> <a href="#" title="Ke Home" class="tip-bottom"><i class="icon-home"></i>Input Data / Identifikasi Masalah dan Solusi</a></div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="widget-box" style="width: 100%;">
                    <div class="widget-title lang_eng" id="judul-eng" style="display: none">
                        <span class="icon"><i class="icon-tasks"></i></span>
                        <h5>Problem Identification form & follow up </h5>
                    </div>
                    <div class="widget-title lang_indo" id="judul-indo">
                        <span class="icon"><i class="icon-tasks"></i></span>
                        <h5>Tabel Identifikasi Masalah dan Solusi</h5>
                    </div>
                    
                   
                    <div class="widget-content">
                        <div class="pull-left" style="width:100%">
                            <select th:field="*{listprov}" class="span3" id="id_prov" name="id_prov">
                                <option value="0" >-- Pilih --</option>
                                <option th:each="list : ${listprov}" th:value="${list.id_prov}" th:text="${list.acronym}"></option>
                            </select>
                            <select id="idrole" name="idrole" class="form-control">
                                <option value="0" >-- Pilih --</option>
                                <option th:each="f:${listNsaProfile}" th:value="${f.id_role}" th:text="${f.nm_role}"></option>
                            </select>
                            
<!--                            <div class="lang_indo"><span> Periode</span></div>
                            <div class="lang_eng"><span> Period</span></div>-->
                            <select id="periode" name="periode" class="form-control">
                                <option value="0" >-- Pilih --</option>
                                <!--<option id="monper" th:each="f:${listranrad}" th:value="${f.id_monper}" th:text="${f.start_year}+' - '+${f.end_year}"></option>-->
                            </select>
                            <div class="input-append pull-right">
                                <div class="span6" align="right">
                    			<button data-toggle="modal" id="add_problem" data-target="#myModal" class="btn btn-primary hide"><i class="icon-plus"></i>
                    				<span class="lang_eng" style="display:none">Add Problem Identify</span><span class="lang_indo">Tambah Identifikasi Masalah</span>
                    			</button>
                                        <a class="btn btn-success appl" id="apply_btn" data-periode="1" style=" margin-left: 10px;display: none">
                                            <span class="lang_indo">Terapkan</span>
                                            <span class="lang_eng">Apply</span>
                                        </a>
                                        <a class="btn btn-warning unappl" id="unapply_btn" data-periode="1" style="margin-left: 10px;display: none">
                                            <span class="lang_indo">Batal Terapkan</span>
                                            <span class="lang_eng">UnApply</span>
                                        </a>
                    		</div>
                            </div>
<!--                            <div class="btn-toolbar lang_eng" style="float:right; display: none" id="btn_eng">
                                <button class="btn btn-warning btn-small tambah">
                                    Add New
                                </button>
                                <button class="btn btn-success btn-small">Import</button>
                                <button class="btn btn-primary btn-small">Export</button>
                            </div>
                            <div class="btn-toolbar lang_indo" style="float:right" id="btn_indo">
                                <button class="btn btn-warning btn-small tambah">
                                    Tambah Baru
                                </button>
                                <button class="btn btn-success btn-small">Impor</button>
                                <button class="btn btn-primary btn-small">Ekspor</button>
                            </div>-->
                        </div>
                        <!--<div class="row-fluid">-->
                            <!--<div class="span12">-->
                                <table class="table table-striped table-bordered" id="tabel-goals" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th style="text-align:center;font-size:80%;" >
                                                <span class="lang_eng" style="display:none">Code</span>
                                                <span class="lang_indo">Kode</span>
                                            </th>
                                            <th style="text-align:center;font-size:80%;" >
                                                <span class="lang_eng" style="display:none">Sdgs Indicator</span>
                                                <span class="lang_indo">Sdg Indicator</span>
                                            </th>
                                            <th style="text-align:center;font-size:80%;">
                                                <span class="lang_eng" style="display:none">Category</span>
                                                <span class="lang_indo">Kategory</span>
                                            </th>
                                            <th style="text-align:center;font-size:80%;" >
                                                <span class="lang_eng" style="display:none">Problem Identify</span>
                                                <span class="lang_indo">Identifikasi Masalah</span>
                                            </th>
                                            <th style="text-align:center;font-size:80%;" >
                                                <span class="lang_eng" style="display:none">Follow Up</span>
                                                <span class="lang_indo">Solusi</span>
                                            </th>
                                            <th style="text-align:center;font-size:80%;" >
                                                <span class="lang_eng" style="display:none">Action</span>
                                                <span class="lang_indo">Aksi</span>
                                            </th>
                                        </tr>
                                    </thead>
<!--                                    <tbody id="tbody-goals">
                                    </tbody>-->
                                </table>
                            <!--</div>-->
                        <!--</div>-->
                    </div>
                </div>
            </div>
        </div>
        <div id="myModal"data-backdrop="static" class="modal hide fade modal-lg" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="width:1000px!important;left:35%!important">
			<div class="modal-header">
			    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
			    <h3 class="lang_eng" style="display:none">Add Disaggregation</h3>
			    <h3 class="lang_indo">Tambah Disaggregation</h3>
		  	</div>
			<div class="modal-body">
				<form>
                                    <input type="hidden" id="id" name="id"/>
                                    <input type="hidden" id="id_relation" name="id_relation"/>
                                    <div class="control-group">
				    <label class="lang_eng" style="display:none">Ref Category</label>
				    <label class="lang_indo">Ref Category</label>
                                    <select id="ref_category" name="ref_category" class="form-control">
                                        <option value="0" >-- Pilih Category --</option>
                                        <option th:each="f:${refcategory.content}" th:value="${f.id_cat}" th:text="${f.nm_cat}"></option>
                                    </select>
                                    </div>
                                    <div class="control-group">
                                    <div class="accordion" id="accordion2">
                                        <div class="accordion-group">
                                            <div class="accordion-heading">
                                                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
                                                    <label class="lang_eng control-label" style="display:none">Select SDGs Indicator</label>
                                                    <label class="lang_indo control-label">Pilih Indikator SDG</label>
                                                </a>
                                            </div>
                                            <div id="collapseOne" class="accordion-body collapse">
                                                <div class="accordion-inner">
                                                    <div id="filter_sdg">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                    <div class="control-group">
                                        <label th:class="control-label" for="detail">Problem</label>
                                        <div class="controls">
                                            <textarea class="input-block-level" id="problem" name="problem" rows="3"></textarea>
                                        </div>
                                    </div>
                                    <div class="control-group">
                                        <label th:class="control-label" for="detail">Follow Up</label>
                                        <div class="controls">
                                            <textarea class="input-block-level" id="follow_up" name="follow_up" rows="3"></textarea>                                            
                                        </div>
                                    </div>
				</form>
			</div>
			<div class="modal-footer">
		    	<button class="btn" data-dismiss="modal" aria-hidden="true">
		    		<span class="lang_eng" style="display:none">Close</span>
		    		<span class="lang_indo">Tutup</span>
		    	</button>
		    	<button class="btn btn-primary" id="submit">
		    		<span class="lang_eng" style="display:none">Submit</span>
		    		<span class="lang_indo">Simpan</span>
		    	</button>
		  	</div>
		</div>
    </div>
    
    <script th:inline="javascript">
        
        var token       = $("meta[name='_csrf']").attr("content");
	var header      = $("meta[name='_csrf_header']").attr("content");
        var id_role     = [[${id_role}]];
        console.log(id_role);
        var id_prov     = [[${id_prov}]];
        var privilege   = [[${privilege}]];
        var filtersdg   = [[${filtersdg}]];
        var lisdg2       = [];
        $2.each(filtersdg.data,function(i,x){
            var obj2 = {'id':x[0],'parent':x[5],'text':x[1],'a_attr':{'level':x[3],'id_parent':x[0]},'state' : {'opened' : true} }
            lisdg2.push(obj2);
        });
        
        $2('#filter_sdg').jstree({ 
                    'core'   : {
                        'data' : lisdg2,
                        'check_callback': false,
                        "themes" : {
                                    "variant" : "small"
                                  }
                    },"checkbox" : {
                        "three_state"   : false,
                        "whole_node"    : false,  // to avoid checking the box just clicking the node 
                        "tie_selection" : false //
                      },
                    "plugins" : [ "checkbox" ] 
                }).on("check_node.jstree", function(e, data) {
//                    console.log(data.node.id + ' ' + data.node.text + ' level '+data.node.level +
//                          (data.node.state.checked ? ' CHECKED': ' NOT CHECKED'));
                    var level = data.node.a_attr.level;
//                    console.log(data);
                    if(level==1){
                        $2('#filter_sdg').jstree(true).uncheck_node(data.node.children_d)
                    }
                     if(level==2){
                        $2('#filter_sdg').jstree(true).uncheck_node(data.node.parent)
                        $2('#filter_sdg').jstree(true).uncheck_node(data.node.children_d)
                    }
                     if(level==3){
                        $2('#filter_sdg').jstree(true).uncheck_node(data.node.parents)
                    }
//                    console.log($2('#filter_sdg').jstree(true).get_checked());
                  });
        function tree(id,data,node_data){
            $2('#sdg_data'+id).jstree({ 
                    'core'   : {
                        'data' : data,
                        'check_callback': false,
                        "themes" : {
                                    "variant" : "small"
                                  }
                    },"checkbox" : {
                        "three_state"   : false,
                        "whole_node"    : false,  // to avoid checking the box just clicking the node 
                        "tie_selection" : false //
                      },
                    "plugins" : [ "checkbox" ] 
                }).on("load_node.jstree", function(e, data) {
                    $2('#sdg_data'+id).jstree(true).check_node(node_data);
                    $2('#sdg_data'+id).jstree(true).disable_checkbox(data.node.children_d);
//                    console.log(data);
                  });
        }
        if(id_role == '1'){

        }else{
            $.ajax({
                type: "GET",
                url: urls+'list-get-option-role-all-profil-notojk/'+id_prov,
                success: function (result) {
                    $("#idrole").html('<option value="0" >-- Pilih --</option>');
                    var array = result.content;
                    if (array != '') {
                        for (i in array) {
                            $("#idrole").append('<option value="'+array[i][0]+'" >'+array[i][1]+'</option>');
                        }
                    }
                    if(privilege == 'ADMIN'){
                        $("#idrole").val('0').trigger("change").attr('disabled',false);
                    }else{
                        $("#idrole").val(id_role).trigger("change").attr('disabled',true);
                    }
                }
            });

            $.ajax({
                type: "GET",
                url: urls+'list-get-option-monper/'+id_prov,
                success: function (result1) {
                    $("#periode").html('<option value="0" >-- Pilih --</option>');
                    var array1 = result1.content;
                    if (array1 != '') {
                        for (i in array1) {
                            var selisih     = (array1[i][2] - array1[i][1]);
//                                console.log(array1[i][2]);
                            var x;
                            for(x=0; x<=selisih; x++){
//                                    console.log((array1[i][1]+x));
                                $("#periode").append('<option value="'+array1[i][0]+'###'+(array1[i][1]+x)+'" >'+(array1[i][1]+x)+'</option>');
                            }

                        }
                    }

                }
            });

            $("#id_prov").val(id_prov).trigger("change").attr('disabled',true);



        }


        $("#id_prov").on('change', function(e){
            var id_prov = this.value ;
            $.ajax({
                type: "GET",
                url: urls+'list-get-option-role-all-profil-notojk/'+id_prov,
                success: function (result) {
                    $("#idrole").html('<option value="0" >-- Pilih --</option>');
                    var array = result.content;
                    if (array != '') {
                        for (i in array) {
                            $("#idrole").append('<option value="'+array[i][0]+'" >'+array[i][1]+'</option>');
                        }
                    }
                    grid();
                }
            });

            $.ajax({
                type: "GET",
                url: urls+'list-get-option-monper/'+id_prov,
                success: function (result1) {
                    $("#periode").html('<option value="0" >-- Pilih --</option>');
                    var array1 = result1.content;
                    if (array1 != '') {
                        for (i in array1) {
                            var selisih     = (array1[i][2] - array1[i][1]);
//                                console.log(array1[i][2]);
                            var x;
                            for(x=0; x<=selisih; x++){
//                                    console.log((array1[i][1]+x));
                                $("#periode").append('<option value="'+array1[i][0]+'###'+(array1[i][1]+x)+'" >'+(array1[i][1]+x)+'</option>');
                            }

                        }
                    }
                }
            });
        });

        $("#periode").on('change', function(e){
            var data_id     = this.value.split("###");;
            var id_monper   = data_id[0];
            var tahun       = data_id[1];
            grid();
             table.columns.adjust();
            $('#add_problem').show();
        });

        $("#idrole").on('change', function(e){
            var data_id     = this.value.split("###");;
            var id_monper   = data_id[0];
            var tahun       = data_id[1];
            grid();
        });


        $('#teruskan').on('click', '#apply_btn', function(e){
            alert('button is not a function');
        });


        //tutup validasi role

        //Bahasa
        var titleDel = "Anda Yakin";
            var messDel = "Menghapus Data?";
            var buttDel = 'Ya, Hapus data ini!';
            var titleOk	= "Hapus";
            var messOk = "Data berhasil dihapus";
            var messNOk = "Data tidak dapat dihapus";
            var required = "Harus diisi";
            function bhs(cek){
                            if(cek){
                                    $(".lang_indo").show();
                            $(".lang_eng").hide();
                            titleDel = "Anda Yakin";
                            messDel = "Menghapus Data?";
                            buttDel = 'Ya, Hapus data ini!';
                            titleOk	= "Hapus";
                    messOk = "Data berhasil dihapus";
                    messNOk = "Data tidak dapat dihapus";
                    required = "Harus diisi";
                    }else{	    	        
                    $(".lang_indo").hide();
                            $(".lang_eng").show();
                            titleDel = "Are you sure";
                            messDel = "Delete this data?";
                            buttDel = 'Yes, Delete this data!';
                            titleOk	= "Delete";
                    messOk = "Delete successful";
                    messNOk = "Can't delete data";
                    required = "Required";
                    }
            }
            if(lang){
                    bhs(lang=="0");
            }else{
                    bhs($('#fs').is(':checked'));
            }

            $('#fs').on('change', function(e){
                grid();
                    bhs($(this).is(':checked'));
            });
            
            var v_idrole    = $("#idrole").val();
            var v_dataid    = $("#periode").val();
            var v_data_id   = v_dataid.split("###");
            var id_monper   = v_data_id[0];
            var tahun       = v_data_id[1];
            var table = $('#tabel-goals').DataTable(
            {
//				sDom: 'lrtip',
				"bLengthChange": false,
				"cache": false,
//                                "scrollX": true,
				"autoWidth": false,
				"responsive":false,
                                 paging:    true,
				"ajax": {
					"url": urls+'list-problem/'+id_monper+'/'+0+'/'+0,
					dataSrc: 'content',
				},
				"searching": false,
				"columns": [
					{"data": function (row, data, index, display) {
						var data   = row[23].split(",");
                                                var grouphtml = "";
                                                $.each(data,function(i,x){
                                                    var dataid          = x.split("###");
                                                    var lengthdataid    = dataid.length-1;
                                                    var htmlid = "";
                                                        $.each(dataid,function(ii,xx){
                                                            if(ii<lengthdataid){
                                                               if(ii==0){                                                               
                                                                    htmlid+= '<label style="display:inline-block;white-space:nowrap;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                }
                                                               if(ii==1){
                                                                   htmlid+=  '<label style="display:inline-block;white-space:nowrap;margin-left:20px;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                }
                                                               if(ii==2){
                                                                   htmlid+=  '<label style="display:inline-block;white-space:nowrap;margin-left:40px;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                } 
                                                            }
                                                        });
                                                    grouphtml +=htmlid;
                                                })
						return grouphtml;
						}},
					{"data": function (row, data, index, display) {
                                                var data   = row[23].split(",");
                                                var grouphtml = "";
                                                $.each(data,function(i,x){
                                                    var dataid          = x.split("###");
                                                    var lengthdataid    = dataid.length-1;
                                                    var dataur          = dataid[lengthdataid].split("##*##");
                                                    var htmlid = "";
                                                        $.each(dataur,function(ii,xx){
                                                               if(ii==0){                                                               
                                                                    htmlid+= '<label style="display:inline-block;white-space:nowrap;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                }
                                                               if(ii==1){
                                                                   htmlid+=  '<label style="display:inline-block;white-space:nowrap;margin-left:20px;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                }
                                                               if(ii==2){
                                                                   htmlid+=  '<label style="display:inline-block;white-space:nowrap;margin-left:40px;font-size:80%;"><span style="vertical-align:middle">'+xx+'</span></label><br>';
                                                                } 
                                                        });
                                                    grouphtml +=htmlid;
                                                })
						return grouphtml;
					}},
                                        {"data": function (row, data, index, display) {
							return "<div style='font-size:80%;'>"+row[13]+"</div>";
					}},
                                        {"data": function (row, data, index, display) {
							return "<div style='font-size:80%;'>"+row[14]+"</div>";
					}},
                                        {"data": function (row, data, index, display) {
							return "<div style='font-size:80%;'>"+row[15]+"</div>";
					}},
                                        {"data": function (row, data, index, display) {
                                                var data =  JSON.stringify(row).replace(/'/g, "&#39");
                                                var id = row[16];
							if(row[17]==1){
                                                            $('#unapply_btn').show();
                                                            $('#add_problem').hide();
                                                            $('#apply_btn').hide();
                                                            return '';
                                                        }else if(row[17]==2||row[17]==4){
                                                            $('#unapply_btn').hide();
                                                            $('#add_problem').hide();
                                                            $('#apply_btn').hide();
                                                            return '';
                                                        }else{
                                                            $('#apply_btn').show();
                                                            $('#unapply_btn').hide(); 
                                                            $('#add_problem').show();
                                                           return "<div style='text-align:center;'>"+
                                                            '<button data-id="'+id+'" type="button" title="update" class="btn btn-warning btn-mini update"><i class="icon-pencil"></i></button>'+
                                                            '<button data-id="'+id+'" type="button" title="delete" class="btn btn-danger btn-mini delete"><i class="icon-trash"></i></button></div>'; 
                                                        }
					}}
					
				],
				columnDefs: [
                                    { "width": "10%", "targets": 0 },
                                    { "width": "50%", "targets": 1 },
                                    { "width": "10%", "targets": 2 },
                                    { "width": "15%", "targets": 3 },
                                    { "width": "15%", "targets": 4 },
                                    { "width": "10%", "targets": 5 },
//                                    {
//                                        "targets": [ 0 ],
//                                        "visible": false,
//                                        "searchable": false
//                                    },
                                ],
//                                fixedColumns: true,
				select: true
			}        
            );	
            

            //memanggil tb spp
            function grid()
            {
                var v_idprov    = $("#id_prov").val();
                var v_idrole    = $("#idrole").val();
                var v_dataid    = $("#periode").val();
                var v_data_id   = v_dataid.split("###");;
                var id_monper   = v_data_id[0];
                var tahun       = v_data_id[1];
//                alert(urls+'list-problem/'+id_monper);
                table.ajax.url(urls+'list-problem/'+id_monper+'/'+tahun+'/'+v_idrole ).load(function(result){
                    var count_data = result.content.length;
                    if(count_data==0){
                        $('#apply_btn,#unapply_btn').hide();
                        $('#add_problem').show();
                    }else{
                    }
                });
                
            }
            
            $('#text-cari').on( 'keyup', function () {
                var val=$(this).val();
                table.search(val).draw();
            });
            
            $('#apply_btn').on('click',function(){
                 var data_ref = table.rows( 0 ).data();
                 var id_goals        = data_ref[0][1];
                 var id_target       = data_ref[0][5];
                 var id_indicator    = data_ref[0][9];
                 var id_monper       = data_ref[0][18];
                 var tahun           = data_ref[0][19];
                 var id_role         = data_ref[0][20];
                            swal({
                                title: "Are You Sure",
                                text: "",
                                type: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Yes'
                            }).then(function () {
                               
//                                console.log(data[0][2]);
//                                return false;
                                 
                                 var data = JSON.stringify({
                                                'id_goals'      :id_goals,
                                                'id_target'     :id_target,
                                                'id_indicator'  :id_indicator,
                                                'id_monper'     :id_monper,
                                                'tahun'         :tahun,
                                                'id_role'       :id_role
                                            });
                                    
                                    $.ajax({
						type: "POST",
                                                url: urls+'problem-identification/aply',
                                                beforeSend : function(xhr){
                                                    xhr.setRequestHeader(header,token);
                                                },
                                                headers:{'Accept':'application/json','Content-Type':'application/json'},
                                                data: data,
                                                success: function (result) {
                                                    table.ajax.url(urls+'list-problem/'+id_monper+'/'+tahun+'/'+id_role).load(function(e){
//                                                        if(e.count_data>0){
                                                             $('#apply_btn').hide();
                                                             $('#add_problem').hide();
                                                             $('#unapply_btn').show();
                                                               $.each(e.content,function(i,x){
                                                                    var node_data = x[22].split(",")
                                                                    tree(x[21],lisdg2,node_data);
                                                                    var id = x[21];
                                                                    $2('#sdg_data'+id).jstree(true).check_node(node_data);

                                                                })
//                                                        }
                                                    });
                                                },
                                            });
                             }, function (dismiss) {
                                if (dismiss === 'cancel') {
                                }
                            });
                               
                        });
            $('#unapply_btn').on('click',function(){
                 var data_ref = table.rows( 0 ).data();
                 var id_goals        = data_ref[0][1];
                 var id_target       = data_ref[0][5];
                 var id_indicator    = data_ref[0][9];
                 var id_monper       = data_ref[0][18];
                 var tahun           = data_ref[0][19];
                 var id_role         = data_ref[0][20];
                            swal({
                                title: "Are You Sure",
                                text: "",
                                type: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Yes'
                            }).then(function () {
                               
//                                console.log(data[0][2]);
//                                return false;
                                 
                                 var data = JSON.stringify({
                                                'id_goals'      :id_goals,
                                                'id_target'     :id_target,
                                                'id_indicator'  :id_indicator,
                                                'id_monper'     :id_monper,
                                                'tahun'         :tahun,
                                                'id_role'       :id_role
                                            });
                                    
                                    $.ajax({
						type: "POST",
                                                url: urls+'problem-identification/un-aply',
                                                beforeSend : function(xhr){
                                                    xhr.setRequestHeader(header,token);
                                                },
                                                headers:{'Accept':'application/json','Content-Type':'application/json'},
                                                data: data,
                                                success: function (result) {
                                                    table.ajax.url(urls+'list-problem/'+id_monper+'/'+tahun+'/'+id_role).load(function(e){
//                                                        if(e.count_data>0){
                                                             $('#apply_btn').show();
                                                             $('#unapply_btn').hide();
                                                             $('#add_problem').show();
                                                               $.each(e.content,function(i,x){
                                                                    var node_data = x[22].split(",")
                                                                    tree(x[21],lisdg2,node_data);
                                                                    var id = x[21];
                                                                    $2('#sdg_data'+id).jstree(true).check_node(node_data);

                                                                })
//                                                        }
                                                    });
                                                },
                                            });
                             }, function (dismiss) {
                                if (dismiss === 'cancel') {
                                }
                            });
             });
             
             
             $('#tabel-goals').on('click', '.update', function(){
				var id = $(this).attr('data-id');
                                var tr          = $(this).closest('tr');
                                var datatable   = table.row(tr).data();
                                var id_goals        = datatable[1];
                                var id_target       = datatable[5];
                                var id_indicator    = datatable[9];
                                var id_filter_sdg   = id_goals+"."+id_target+"."+id_indicator;
                                var check_node      = datatable[22].split(",");
                                console.log(check_node);
//                                return false;
                                var id_relation     = datatable[21];
//                                var node_data =[];
//                                $.each(check_node,function(ii,xx){
//                                    node_data.push(xx.id_sdgs);
//                                });
//                                console.log(node_data);
                                $2('#filter_sdg').jstree(true).check_node(check_node);
				$.ajax({
					type: "GET",
                                    url: urls+'problem/get-problem/'+id,
                                    success: function (result) {
                                        var val = result.content;
                                        $('#id').val(val[0].id);
                                        $('#ref_category').val(val[0].id_cat)
                                        $('#problem').val(val[0].problem)
                                        $('#filter_sdg').val(id_filter_sdg).trigger('change');
                                        $('#follow_up').val(val[0].follow_up)
                                        $('#id_relation').val(id_relation);
                                        $('#myModal').modal('show');
                                    },
                                })
             }).on('click', '.detail', function(){
                    var tr          = $(this).closest('tr');
                    var datatable   = table.row(tr).data();
                    var id_goals        = datatable[1];
                    var id_target       = datatable[5];
                    var id_indicator    = datatable[9];
                    var id_filter_sdg   = id_goals+"."+id_target+"."+id_indicator;
                    console.log(id_filter_sdg);
				var id = $(this).attr('data-id');
				$.ajax({
					type: "GET",
                                    url: urls+'problem/get-problem/'+id,
                                    success: function (result) {
                                        var val = result.content;
                                        $('#id').val(val[0].id);
                                        $('#ref_category').val(val[0].id_cat).attr("readonly",true);
                                        $('#problem').val(val[0].problem).attr("readonly",true);
                                        $('#follow_up').val(val[0].follow_up).attr("readonly",true);
                                        $('#filter_sdg').val(id_filter_sdg).trigger('change');//attr("readonly",true);
                                        $("#filter_sdg").attr("disabled",true);
                                        $('#submit').prop('disabled',true);
                                        $('#myModal').modal('show');
                                    },
                                })
             }).on('click', '.delete', function(){
                    var id          = $(this).attr('data-id');
                    var tr          = $(this).closest('tr');
                    var datatable   = table.row(tr).data();
                    var id_monper   = datatable[18];
                    var tahun       = datatable[19];
                    var id_role     = datatable[20];
                    var id_relation = datatable[21];
                    swal({
                    title: titleDel,
                    text: messDel,
                    type: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: buttDel
                }).then(function () {
                	$.ajax({
    					type: "DELETE",
                        url: urls+'problem-identification/delete/'+id+'/'+id_relation,
                        beforeSend : function(xhr){
                        	xhr.setRequestHeader(header,token);
                        },
                        success: function (result) {
                        	swal(titleOk,messOk,'success');
                                grid();
                        },
                        error:function (result) {
                        	swal(titleOk,messNOk,'error');
                        },
                    })
                }, function (dismiss) {
                    if (dismiss === 'cancel') {
                    }
                })
             });
             
             function clearForm(){
				$('#id').val("").removeAttr("readonly");
                                $('#id_relation').val("").removeAttr("readonly");
				$('#ref_category').val("").removeAttr("readonly");
				$('#problem').val("").removeAttr("readonly");
				$('#follow_up').val("").removeAttr("readonly");
                                $('#filter_sdg').val("").removeAttr("readonly");
                                $('#submit').removeAttr("Disabled");
                                $2('#filter_sdg').jstree(true).uncheck_all();
				$('.control-group').removeClass('error');
				$('.help-block').text("");
			}
			
			$('#myModal').on('hidden.bs.modal',function(){
				clearForm();
			});
        $('#submit').on('click', function(){
            var id              = $('#id').val();
            var id_relation     = $('#id_relation').val();
            var id_cat          = $('#ref_category').val();
            var v_dataid        = $("#periode").val();
            var v_data_id       = v_dataid.split("###");;
            var id_monper       = v_data_id[0];
            var tahun           = v_data_id[1];
            var v_idrole        = $("#idrole").val();
            var id_prov         = $("#id_prov").val();
            var problem         = $('#problem').val();
            var follow_up       = $('#follow_up').val();
            var sdgs_group      = $('#filter_sdg').val();
            var data_sdgs_map   = $2('#filter_sdg').jstree(true).get_checked();
            var sdgs_map =[];
            $.each(data_sdgs_map,function(i,x){
                var id_goals,id_target,id_indicator ="";
                var split_length = (x.split('.').length-1);
                var split        =  x.split('.');
                if(split_length==0){
                    id_goals = x;
                    id_target       = "";
                    id_indicator    = "";
                    
                }
                if(split_length==1){
                    
                    id_goals     = split[0];
                    id_target    = split[1];
                    id_indicator    = "";
                }
                if(split_length==2){
                    
                    id_goals        = split[0];
                    id_target       = split[1];
                    id_indicator    = split[2];
                }
                sdgs_map.push({
                                'id_prov'       :id_prov,
                                'id_monper'     :id_monper,
                                'id_goals'      :id_goals,
                                'id_target'     :id_target,
                                'id_indicator'  :id_indicator
                                ,'id_sdgs'      :x
                            });
                
            });
           
            var sdgs_group_split = sdgs_group.split(".");
            var id_goals         = sdgs_group_split[0];
            var id_target        = sdgs_group_split[1];
            var id_indicator     = sdgs_group_split[2];
            
            $('.control-group').removeClass('error');
            $('.help-block').text("");

            var data = JSON.stringify({
                            'id'            :id,
                            'id_cat'        :id_cat,
                            'id_goals'      :id_goals,
                            'id_target'     :id_target,
                            'id_indicator'  :id_indicator,
                            'problem'       :problem,
                            'follow_up'     :follow_up,
                            'id_monper'     :id_monper,
                            'id_role'       :v_idrole,
                            'id_prov'       :id_prov,
                            'tahun'         :tahun,
                            'id_relation'   :id_relation,
                            'sdgs_map'      :sdgs_map
                        });
                    $.ajax({
                            type: "POST",
                            url: urls+'problem-identification/save',
                            beforeSend : function(xhr){
                                xhr.setRequestHeader(header,token);
                            },
                            headers:{'Accept':'application/json','Content-Type':'application/json'},
                                                data: data,
                            success: function (result) {
                               grid();// table.ajax.url(urls+'list-problem/'+id_monper+'/'+tahun+'/'+v_idrole).load();
                                $('#myModal').modal('hide');
                            },
                        });
        });
        
        
       
    </script>
</body>
<style>
    .select2-container--open {
        z-index: 9999999
    }
    table{
        margin: 0 auto;
        width: 100%;
        clear: both;
        border-collapse: collapse;
        table-layout: fixed; 
        word-wrap:keep-all; 
      }
</style>

</html>